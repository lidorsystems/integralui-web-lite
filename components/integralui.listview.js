/*
  filename: integralui.listview.js
  version : 20.2.0
  Copyright Â© 2020 Lidor Systems. All rights reserved.

  This file is part of the "IntegralUI Web Lite" Library. 
                                                                   
  The contents of this file are subject to the IntegralUI Web Lite License, and may not be used except in compliance with the License.
  A copy of the License should have been installed in the product's root installation directory or it can be found at
  http://www.lidorsystems.com/products/web/lite/license-agreement.aspx.
                                                            
  This SOFTWARE is provided "AS IS", WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License for the specific language 
  governing rights and limitations under the License. Any infringement will be prosecuted under applicable laws.                           
*/
import{c as css,h as html}from"../external/lit-element.js";import{c as classMap}from"../external/class-map.js";import{s as styleMap}from"../external/style-map.js";import{IntegralUIScrollMode,IntegralUITheme}from"./integralui.enums.js";import IntegralUIBaseList from"./integralui.base.list.js";import"./integralui.scrollbar.js";import{iuiListItemDefaultStyle}from"../styles/integralui.listitem.style.js";import{iuiListItemOfficeStyle}from"../themes/office/integralui.listitem.office.js";import{iuiListItemMidnightStyle}from"../themes/midnight/integralui.listitem.midnight.js";import{iuiListViewDefaultStyle}from"../styles/integralui.listview.style.js";import{iuiListViewOfficeStyle}from"../themes/office/integralui.listview.office.js";import{iuiListViewMidnightStyle}from"../themes/midnight/integralui.listview.midnight.js";class IntegralUIListView extends IntegralUIBaseList{_ini(){super._ini();this._clSpc={width:0,height:0};this._cntPs={top:0,left:0};this._cItSz={width:0,height:0};this._iPCl=0;this._iPRw=0;this._nmCls=0;this._nmRws=0;this._cScMd=IntegralUIScrollMode.Horizontal;this._ovwStt={horizontal:"auto",vertical:"auto"};this._cCtrStyStt=iuiListViewDefaultStyle;this._cItStyStt=iuiListItemDefaultStyle;this._cItThStt=css``;this._gnrCsNm="iui-listview";this._iCsNm="iui-listitem";this._iCntCsNm=this._iCsNm+"-content";this._uOpt();this._iniStyle();this._uDt()}connectedCallback(){super.connectedCallback()}disconnectedCallback(){super.disconnectedCallback();this._rstLyTm()}attributeChangedCallback(t,i,s){super.attributeChangedCallback(t,i,s)}static get properties(){return{itemSize:{type:Object,attribute:"item-size"},scrollMode:{attribute:"scroll-mode",converter:{fromAttribute:t=>"horizontal"===(t=t.replace(/"|'/,"").replace(/"|'/,"")).toLowerCase()?IntegralUIScrollMode.Horizontal:IntegralUIScrollMode.Vertical,toAttribute:(t,i)=>t===IntegralUIScrollMode.Horizontal?"Horizontal":"Vertical"},reflect:!0}}}get itemSize(){return this._cItSz}set itemSize(t){if(t){const i=this._cItSz;this._cItSz={width:t.width>0?t.width+4:0,height:t.height>0?t.height+4:0};this.requestUpdate("itemSize",i);this.updateLayout()}}get scrollMode(){return this._cScMd}set scrollMode(t){if(this._cScMd!==t){const i=this._cScMd;this._cScMd=t;this._cntPs={top:0,left:0};this._cIdx=0;this._cSclPs={x:0,y:0};this.requestUpdate("scrollMode",i);this.updateLayout()}}_updateOverflowSettings(){if(!1!==this.virtualMode)this._ovwStt={horizontal:"hidden",vertical:"hidden"};else if(this._cScMd===IntegralUIScrollMode.Horizontal)this._ovwStt={horizontal:"auto",vertical:"hidden"};else this._ovwStt={horizontal:"hidden",vertical:"auto"}}_adItCLt(t){t.type="item";if(!t[this._opt.dataFields.id])t[this._opt.dataFields.id]=this._cmnSrv.getUniqueId();if(this._isItAlw(t))this._cLt.push({data:t})}loadData(t,i){this._prcLdDt(t,null,i)}_uCLt(){this._cLt.length=0;let t=this._cDtaService.getList();if(t)t.map(t=>this._adItCLt(t))}_uScItLt(){this._rstScItLt();this._scItLt.length=0;this.update();let t={x:0,y:0},i=1;for(let s=this._cIdx;s<this._cLt.length&&s<this._cIdx+this._vblRg;s++,i++){let e=this._cLt[s],l={clickPos:{x:0,y:0},data:e.data,index:s-this._cIdx,position:{x:0,y:0},inlineStyle:this._gItInSty(e),style:{},tabIndex:i};if(this.scrollMode===IntegralUIScrollMode.Horizontal){if(t.y+this._cItSz.height>this._clSpc.height)t={x:t.x+this._cItSz.width,y:0};l.position={x:t.x,y:t.y};t.y+=this._cItSz.height}else{if(t.x+this._cItSz.width>this._clSpc.width)t={x:0,y:t.y+this._cItSz.height};l.position={x:t.x,y:t.y};t.x+=this._cItSz.width}this._uItSty(l);this._scItLt.push(l)}}_prcDnArwKey(t,i){let s=this._gDnIt(t);if(s){this._cFOj=s;let t=this,e=setTimeout(function(){t._prcSel(i,s.data);clearTimeout(e)},1),l=Math.floor(this._vblRg/2);if(t.scrollMode===IntegralUIScrollMode.Horizontal){if(s.index>=l-this._iPCl)this.scrollPos({x:this._cSclPs.x+this.itemSize.width,y:this._cSclPs.y})}else if(s.index>=l-this._iPRw)this.scrollPos({x:this._cSclPs.x,y:this._cSclPs.y+this.itemSize.height})}return s}_prcEdKey(t,i){let s=null,e=this;if(e._scItLt.length>0){if(e.scrollMode===IntegralUIScrollMode.Horizontal)e.scrollPos({x:e._mxSclPs.x,y:e._cSclPs.y});else e.scrollPos({x:e._cSclPs.x,y:e._mxSclPs.y});setTimeout(function(){s=e._scItLt[e._scItLt.length-1];e._cFOj=s;let t=setTimeout(function(){e._prcSel(i,s.data);clearTimeout(t)},1)},1)}return s}_prcHmKey(t,i){let s=null,e=this;if(e._scItLt.length>0){if(e.scrollMode===IntegralUIScrollMode.Horizontal)e.scrollPos({x:0,y:e._cSclPs.y});else e.scrollPos({x:e._cSclPs.x,y:0});setTimeout(function(){s=e._scItLt[0];e._cFOj=s;let t=setTimeout(function(){e._prcSel(i,s.data);clearTimeout(t)},1)},1)}return s}_prcLfArwKey(t,i){let s=this._gLtIt(t);if(s){this._cFOj=s;let t=this,e=setTimeout(function(){t._prcSel(i,s.data);clearTimeout(e)},1);if(t.scrollMode===IntegralUIScrollMode.Horizontal){if(s.index<this._iPCl)this.scrollPos({x:this._cSclPs.x-this.itemSize.width,y:this._cSclPs.y})}else if(s.index<this._iPRw)this.scrollPos({x:this._cSclPs.x,y:this._cSclPs.y-this.itemSize.height})}return s}_prcPgDnKey(t,i){let s=null,e=this;if(e._scItLt.length>0){let l=0;if(e.scrollMode===IntegralUIScrollMode.Horizontal){l=Math.floor((e._vblRg-2*e._iPCl)/2);if(e._iPCl>0)e.scrollPos({x:e._cSclPs.x+Math.floor(l*e.itemSize.width/e._iPCl),y:e._cSclPs.y})}else{l=Math.floor((e._vblRg-2*e._iPRw)/2);if(e._iPRw>0)e.scrollPos({x:e._cSclPs.x,y:e._cSclPs.y+Math.floor(l*e.itemSize.height/e._iPRw)})}setTimeout(function(){let l=t.index>=0&&t.index<e._scItLt.length?t.index:e._scItLt.length-1;l=e.scrollMode===IntegralUIScrollMode.Horizontal?e._cSclPs.x===e._mxSclPs.x?e._scItLt.length-1:l:e._cSclPs.y===e._mxSclPs.y?e._scItLt.length-1:l;s=e._scItLt[l];e._cFOj=s;let h=setTimeout(function(){e._prcSel(i,s.data);clearTimeout(h)},1)},1)}return s}_prcPgUpKey(t,i){let s=null,e=this;if(e._scItLt.length>0){let l=0;if(e.scrollMode===IntegralUIScrollMode.Horizontal){l=Math.floor((this._vblRg-2*this._iPCl)/2);if(e.itemsPerColumn>0)e.scrollPos({x:e._cSclPs.x-Math.floor(l*e.itemSize.width/this._iPCl),y:e._cSclPs.y})}else{l=Math.floor((this._vblRg-2*this._iPRw)/2);if(e._iPRw>0)e.scrollPos({x:e._cSclPs.x,y:e._cSclPs.y-Math.floor(l*e.itemSize.height/this._iPRw)})}setTimeout(function(){let l=t.index>=0&&t.index<e._scItLt.length?t.index:0;l=e.scrollMode===IntegralUIScrollMode.Horizontal?0===e._cSclPs.x?0:l:0===e._cSclPs.y?0:l;s=e._scItLt[l];e._cFOj=s;let h=setTimeout(function(){e._prcSel(i,s.data);clearTimeout(h)},1)},1)}return s}_prcRtArwKey(t,i){let s=this._gRtIt(t);if(s){this._cFOj=s;let t=this,e=setTimeout(function(){t._prcSel(i,s.data);clearTimeout(e)},1),l=Math.floor(this._vblRg/2);if(t.scrollMode===IntegralUIScrollMode.Horizontal){if(s.index>=l-this._iPCl)this.scrollPos({x:this._cSclPs.x+this.itemSize.width,y:this._cSclPs.y})}else if(s.index>=l-this._iPRw)this.scrollPos({x:this._cSclPs.x,y:this._cSclPs.y+this.itemSize.height})}return s}_prcUpArwKey(t,i){let s=this._gUpIt(t);if(s){this._cFOj=s;let t=this,e=setTimeout(function(){t._prcSel(i,s.data);clearTimeout(e)},1);if(t.scrollMode===IntegralUIScrollMode.Horizontal){if(s.index<this._iPCl)this.scrollPos({x:this._cSclPs.x-this.itemSize.width,y:this._cSclPs.y})}else if(s.index<this._iPRw)this.scrollPos({x:this._cSclPs.x,y:this._cSclPs.y-this.itemSize.height})}return s}_gDnIt(t){let i=t.index>=0&&t.index<this._scItLt.length-1?t.index+1:-1;if(this.scrollMode!==IntegralUIScrollMode.Horizontal)i=(i=t.index+this._iPRw)>=0&&i<this._scItLt.length?i:-1;return i>=0?this._scItLt[i]:null}_gLtIt(t){let i=t.index-this._iPCl;i=i>=0&&i<this._scItLt.length?i:-1;if(this.scrollMode!==IntegralUIScrollMode.Horizontal)i=t.index>0?t.index-1:-1;return i>=0&&i<this._scItLt.length?this._scItLt[i]:null}_gRtIt(t){let i=t.index+this._iPCl;i=i>=0&&i<this._scItLt.length?i:-1;if(this.scrollMode!==IntegralUIScrollMode.Horizontal)i=t.index>=0&&t.index<this._scItLt.length-1?t.index+1:-1;return i>=0&&i<this._scItLt.length?this._scItLt[i]:null}_gUpIt(t){let i=t.index>0?t.index-1:-1;if(this.scrollMode!==IntegralUIScrollMode.Horizontal)i=(i=t.index-this._iPRw)>=0&&i<this._scItLt.length?i:-1;return i>=0?this._scItLt[i]:null}_iMuDn(t,i){if(this._enbl){this._isIClk=!0;if(this._opt.allowFocus&&1===t.buttons)this._cFOj=i;this._prcSel(t,i.data);if(this._prevClickedObj)this._prevClickedObj.isClicked=!1;i.isClicked=!0;let s=this._cmnSrv.getShiftPos(),e=this._cmnSrv.getMousePos(t);e.x-=s.x;e.y-=s.y;let l=this._cmnSrv.getPageRect(this._eRf);i.clickPos.x=Math.abs(e.x-l.left-i.position.x);this._prevClickedObj=i}t.stopPropagation()}_gCntSz(){return this.contentElem?{width:this.contentElem.offsetWidth,height:this.contentElem.offsetHeight}:{width:0,height:0}}_prcULy(){let t=this;return new Promise(i=>{if(t._alwUp){t._updateOverflowSettings();t._rstLyTm();t._uTmr=setTimeout(function(){t._uCLt();if(0===t._cLt.length)t._cSclPs={x:0,y:0};t._clRc={width:t._eRf.clientWidth,height:t._eRf.clientHeight};t._uScItLt();t.update();let s=setTimeout(function(){t._uItEls();t._uBlkSz();t._avgItHt=t.itemSize.height;t._animateItemSize={width:t.itemSize.width,height:t.itemSize.height};t._uScSz();t._uVblRng();t._uScItLt();t.refresh();t._inkEv("updateComplete");t._uItEls();clearTimeout(s);i()},1);clearTimeout(t._uTmr)},1)}})}_uScSz(){let t=this;t._cntSz={width:t._clRc.width,height:t._clRc.height};if(this._cScMd===IntegralUIScrollMode.Horizontal){this._iPCl=Math.floor(this._clRc.height/this.itemSize.height);let i=this._iPCl>0?this._cLt.length/this._iPCl:0;this._nmCls=Math.floor(i);if(this._nmCls<i)this._nmCls++;let s=this._nmCls*this.itemSize.width-t._clRc.width+2;if(s>0){this._iPCl=Math.floor((this._clRc.height-16)/this.itemSize.height);i=this._iPCl>0?this._cLt.length/this._iPCl:0;this._nmCls=Math.floor(i);if(this._nmCls<i)this._nmCls++;s=this._nmCls*this.itemSize.width-t._clRc.width+2}t._scSz.width=s;t._cntSz.width+=this.itemSize.width}else{this._iPRw=Math.floor(this._clSpc.width/this.itemSize.width);let i=this._iPRw>0?this._cLt.length/this._iPRw:0;this._nmRws=Math.floor(i);if(this._nmRws<i)this._nmRws++;let s=this._nmRws*this.itemSize.height-t._clRc.height+2;if(s>0){this._iPRw=Math.floor((this._clRc.width-16)/this.itemSize.width);i=this._iPRw>0?this._cLt.length/this._iPRw:0;this._nmRws=Math.floor(i);if(this._nmRws<i)this._nmRws++;s=this._nmRws*this.itemSize.height-t._clRc.height+2}t._scSz.height=s;t._cntSz.height+=this.itemSize.height}if(t.isVerScrollVisible()){t._cntSz.width-=18;if(t._scSz.width>0)t._scSz.width+=16}if(t.isHorScrollVisible())t._scSz.height+=16;t._scSz.width=t._scSz.width>0?t._scSz.width:0;t._scSz.height=t._scSz.height>0?t._scSz.height:0;t._mxSclPs={x:t._scSz.width,y:t._scSz.height};if(t._cSclPs.x>t._mxSclPs.x)t._chgHScPs(t._mxSclPs.x);if(t._cSclPs.y>t._mxSclPs.y)t._chgVScPs(t._mxSclPs.y);t._scBrSz={width:t.isVerScrollVisible()?t._clRc.width-20:t._clRc.width-4,height:t.isHorScrollVisible()?t._clRc.height-20:t._clRc.height-4};t._scLChg={x:t._scBrSz.width,y:t._scBrSz.height};t._clSpc={width:t._clRc.width,height:t._clRc.height};if(t.isHorScrollVisible())t._clSpc.height-=16;if(t.isVerScrollVisible())t._clSpc.width-=16}_uVblRng(){this._vblRg=1;let t=this._gItElList();if(t&&t.length>0)if(this._cScMd===IntegralUIScrollMode.Horizontal)this._vblRg=2*Math.floor(this._clSpc.height/this.itemSize.height)*(Math.floor(this._clSpc.width/this.itemSize.width)+1);else this._vblRg=2*(Math.floor(this._clSpc.height/this.itemSize.height)+1)*Math.floor(this._clSpc.width/this.itemSize.width)}_chgHScPs(t){this._cSclPs.x=Math.max(0,Math.min(t,this._mxSclPs.x));if(this._cSclPs.x!==this.prevScrollPos.x){this.updateView();this.scrollPosChanged.emit({value:this.scrollPos()});this.prevScrollPos.x=this._cSclPs.x}}isVerScrollVisible(){if(!this.virtualMode||this._cScMd===IntegralUIScrollMode.Horizontal)return!1;else return this._enbl&&this._scSz.height>0?!0:!1}isHorScrollVisible(){if(!this.virtualMode||this._cScMd===IntegralUIScrollMode.Vertical)return!1;else return this._enbl&&this._scSz.width>0?!0:!1}_oHScChg(t){this._chgHScPs(t.value)}updateView(){if(this._cScMd===IntegralUIScrollMode.Horizontal){let t=Math.floor(this._clSpc.height/this.itemSize.height),i=Math.floor(this._cSclPs.x/this.itemSize.width);this._cntPs.left=this._cSclPs.x-i*this.itemSize.width;this._cIdx=i*t}else{let t=Math.floor(this._clSpc.width/this.itemSize.width),i=Math.floor(this._cSclPs.y/this.itemSize.height);this._cntPs.top=this._cSclPs.y-i*this.itemSize.height;this._cIdx=i*t}if(this._cIdx!==this.prevIndex){this._uScItLt();this._prvIdx=this._cIdx;this.update();this._uItEls()}}_lvMuWh(t){if(this._enbl)this._prcMuWh(t,this.scrollMode===IntegralUIScrollMode.Horizontal)}scrollTo(t){if(!1!==this.virtualMode&&t){let i=this._gItCIdx(t);if(i>=0){let t=0;if(this._cScMd===IntegralUIScrollMode.Horizontal){if(this._iPCl>0&&this.itemSize.width>0){t=this.itemSize.width*(i/this._iPCl-Math.floor(this._clSpc.width/this.itemSize.width)+1);this.scrollPos({x:t,y:this._cSclPs.y})}}else if(this._iPRw>0&&this.itemSize.height>0){t=this.itemSize.height*(i/this._iPRw-Math.floor(this._clSpc.height/this.itemSize.height)+1);this.scrollPos({x:this._cSclPs.x,y:t})}this.updateLayout()}}}_gCtrSty(){let t={cursor:this._ctrCrs,"overflow-x":this._ovwStt.horizontal,"overflow-y":this._ovwStt.vertical};if(this._ctrSz.width>0)t.width=this._ctrSz.width+"px";if(this._ctrSz.height>0)t.height=this._ctrSz.height+"px";return t}_gItInSty(t){let i=t.data[this._opt.dataFields.style]||{};i.position="absolute";if(t.position){i.top=t.position.y+"px";i.left=t.position.x+"px"}i.width=this._cItSz.width-4+"px";i.height=this._cItSz.height-4+"px";return i}_rstRf(){if(this._rfshTm)clearTimeout(this._rfshTm);this._rfshTm=null}refresh(t){this._rstRf();if(!1!==this.virtualMode){this._uCtrCs();this._scItLt.map(t=>this._uItSty(t))}this.update();this._uRf()}_uThSt(t){this._cThmSettings=css``;this._cItThStt=css``;switch(t){case IntegralUITheme.Office:this._cThmSettings.cssText=this._cmnSrv.replaceAll(iuiListViewOfficeStyle.cssText,"../icons",this._cRsPt);this._cItThStt.cssText=this._cmnSrv.replaceAll(iuiListItemOfficeStyle.cssText,"../icons",this._cRsPt);break;case IntegralUITheme.Midnight:this._cThmSettings.cssText=this._cmnSrv.replaceAll(iuiListViewMidnightStyle.cssText,"../icons",this._cRsPt);this._cItThStt.cssText=this._cmnSrv.replaceAll(iuiListItemMidnightStyle.cssText,"../icons",this._cRsPt);break;default:this._cThmSettings.cssText="";this._cItThStt.cssText=""}}firstUpdated(t){this._uRf();this.updateLayout()}updated(t){t.forEach((t,i)=>{});this._uFcIt()}render(){return html`\n            <style>\n                ${this._cCtrStyStt}\n                ${this._cItStyStt}\n                ${this._cThmSettings}\n                ${this._cItThStt}\n                ${this._cCmSty}\n                </style>\n            <div data-ctrl="listview" class=${classMap(this._gCtrCs())} style=${styleMap(this._gCtrSty())} @DOMMouseScroll="${t=>this._lvMuWh(t)}" @mousewheel="${t=>this._lvMuWh(t)}" @mouseenter="${t=>this._oCMuEnt(t)}" @mouseleave="${t=>this._oCMuLv(t)}" @scroll="${t=>this._oSc(t)}">\n                <ul id="content" @touchstart="${t=>this._ctrTchSt(t)}" @touchend="${t=>this._ctrTchEd(t)}" style=${styleMap({left:-this._cntPs.left+"px",top:-this._cntPs.top+"px",width:this._cntSz.width+"px",height:this._cntSz.height+"px",position:"absolute",margin:0,padding:0})}>\n                    ${this._scItLt.map((t,i)=>html`\n                        <li data-item class=${classMap({"iui-listitem-general":!this.allowAnimation,"iui-listitem-animate":this.allowAnimation,"iui-listitem-animate-enter-suspended":this.allowAnimation&&t.data===this._hIt})} @mouseenter="${i=>this._iMuEnt(i,t)}" @mouseleave="${i=>this._iMuLv(i,t)}" style=${styleMap(t.inlineStyle)}">\n                            <div class=${classMap(t.style.general)} style=${styleMap({width:t.inlineStyle.width,height:t.inlineStyle.height})} @click="${i=>this._iClkEv(i,t)}" @dblclick="${i=>this._iDClkEv(i,t)}" @contextmenu="${i=>this._iRClkEv(i,t)}" @mousedown="${i=>this._iMuDn(i,t)}" @mouseup="${i=>this._iMuUp(i,t)}" @touchstart="${i=>this._iTchSt(i,t)}" @touchmove="${i=>this._iTchMu(i,t)}" @touchend="${i=>this._iTchEd(i,t)}">\n                                <div data-item-content class=${classMap(t.style.content)} tabindex="${t.tabIndex}" @focus="${i=>this._iGtFc(t)}" @blur="${i=>this._iLtFc(t)}" @keydown="${i=>this._iKeyDn(i,t)}" @keypress="${i=>this._iKeyPrs(i,t)}" @keyup="${i=>this._iKeyUp(i,t)}">\n                                    ${this._gItTpl(t.data)}\n                                </div>\n                            </div>\n                        </li>\n                    `)}\n                </ul>\n                ${this.isVerScrollVisible()?html`<iui-scrollbar id="ver-scroll" .enabled="${this.enabled}" .value="${this._cSclPs.y}" .max="${this._mxSclPs.y}" .largeChange="${this._scLChg.y}" .height="${this._scBrSz.height}" .theme="${this._cThm}" @mouseenter="${t=>this._scMuEnt(t)}" @valueChanged="${t=>this._oVScChg(t)}" @scrollStart="${t=>this._oVScSt(t)}" @scrollEnd="${t=>this._oVScEd(t)}"></iui-scrollbar>`:html``}\n                ${this.isHorScrollVisible()?html`<iui-scrollbar id="hor-scroll" .enabled="${this.enabled}" orientation="Horizontal" .value="${this._cSclPs.x}" .max="${this._mxSclPs.x}" .width="${this._scBrSz.width}" .theme="${this._cThm}" @mouseenter="${t=>this._scMuEnt(t)}" @valueChanged="${t=>this._oHScChg(t)}" @scrollStart="${t=>this._oHScSt(t)}" @scrollEnd="${t=>this._oHScEd(t)}"></iui-scrollbar>`:html``}\n                ${this.isVerScrollVisible()&&this.isHorScrollVisible()?html`<div class="iui-scrollbar-corner" style="position:absolute;right:0;bottom:0;width:16px;height:16px;"></div>`:html``}\n            </div>\n        `}_uCtrStyStt(t){this._cCtrStyStt=css``;this._cCtrStyStt.cssText=this._cmnSrv.replaceAll(iuiListViewDefaultStyle.cssText,"../icons",t);this._cItStyStt=css``;this._cItStyStt.cssText=this._cmnSrv.replaceAll(iuiListItemDefaultStyle.cssText,"../icons",t)}_uRf(){this._eRf=this.shadowRoot.querySelector("div[data-ctrl=listview]");this._contentElem=this.shadowRoot.querySelector("#content")}}window.customElements.define("iui-listview",IntegralUIListView);export default IntegralUIListView;